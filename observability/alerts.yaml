groups:
  - name: module-runtime
    interval: 30s
    rules:
      - alert: ModuleHighErrorRate
        expr: |
          sum(rate(nhb_module_requests_total{outcome="error"}[5m])) by (module)
            /
          clamp_min(sum(rate(nhb_module_requests_total[5m])) by (module), 1e-9)
            > 0.05
        for: 10m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High module error rate"
          description: |
            Module {{ $labels.module }} is returning errors for more than 5% of
            requests over the last 10 minutes (current error rate: {{ $value | printf "%.2f" }}).
            Inspect nhb_module_errors_total for offending methods and review the RPC logs.

      - alert: ModuleLatencyP95Degraded
        expr: |
          histogram_quantile(0.95,
            sum(rate(nhb_module_request_duration_seconds_bucket[5m])) by (module, method, le)
          ) > 1
        for: 15m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Module latency regression"
          description: |
            The p95 latency for module {{ $labels.module }} method {{ $labels.method }}
            exceeded 1s for the past 15 minutes. Review downstream dependencies and
            recent deployments.

      - alert: ModuleThrottleSaturation
        expr: sum(increase(nhb_module_throttles_total[5m])) by (module, reason) > 25
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Module throttles saturating"
          description: |
            Module {{ $labels.module }} is rejecting requests due to {{ $labels.reason }}
            more than 25 times in 5 minutes. Validate quota configuration and client behaviour.

      - alert: ModulePauseEngaged
        expr: |
          max_over_time(nhb_module_throttles_total{reason="pause"}[1h])
            - min_over_time(nhb_module_throttles_total{reason="pause"}[1h]) > 0
        for: 30m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Module pause engaged"
          description: |
            A pause guard for module {{ $labels.module }} engaged within the last hour.
            Confirm the pause was intentional and follow the incident response runbook.

      - alert: OracleFeedStale
        expr: max(nhb_oracle_update_age_seconds) > 120
        for: 5m
        labels:
          severity: critical
          team: data
        annotations:
          summary: "Oracle feed stale"
          description: |
            The latest oracle update age exceeded two minutes. Verify upstream feeds
            and restart the swap oracle pipeline if required.

      - alert: ModuleQuotaExhausted
        expr: sum(increase(nhb_module_throttles_total{reason="quota"}[10m])) by (module) > 0
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Module quota exhaustion"
          description: |
            Module {{ $labels.module }} exhausted its address quota in the last ten minutes.
            Coordinate with consumers on request backoff or increase the configured limits.

      - alert: OracleAttestationFreshness
        expr: max(nhb_oracle_attesterd_oracle_freshness_seconds) > 120
        for: 5m
        labels:
          severity: critical
          team: data
        annotations:
          summary: "Oracle attestation freshness degraded"
          description: |
            The latest attested voucher is more than two minutes old. Check oracle-attesterd
            logs for stalled webhooks or consensus submission failures.

      - alert: PayoutdErrorSpike
        expr: sum(increase(nhb_payoutd_errors_total[5m])) by (asset) > 3
        for: 10m
        labels:
          severity: warning
          team: treasury
        annotations:
          summary: "Payoutd error spike"
          description: |
            More than three payout failures occurred within five minutes for asset {{ $labels.asset }}.
            Inspect payoutd logs to identify transfer, confirmation, or attestation failures.

      - alert: PayoutdLatencyP95Breached
        expr: |
          histogram_quantile(0.95,
            sum(rate(nhb_payoutd_payout_latency_seconds_bucket[5m])) by (asset, le)
          ) > 30
        for: 15m
        labels:
          severity: critical
          team: treasury
        annotations:
          summary: "Payout latency regression"
          description: |
            The p95 settlement latency exceeded 30s for asset {{ $labels.asset }} over the last 15 minutes.
            Review wallet health, blockchain congestion, and attestor availability.

      - alert: PayoutdCapUtilizationHigh
        expr: max_over_time(nhb_payoutd_cap_utilization[10m]) > 0.8
        for: 10m
        labels:
          severity: warning
          team: treasury
        annotations:
          summary: "Payout cap utilisation above 80%"
          description: |
            Cap utilisation for asset {{ $labels.asset }} exceeded 80% in the past 10 minutes.
            Consider replenishing treasury inventory or raising the configured daily cap.

      - alert: PayoutdPauseEngaged
        expr: max_over_time(nhb_payoutd_pause_engaged[5m]) >= 1
        for: 5m
        labels:
          severity: critical
          team: treasury
        annotations:
          summary: "Payoutd pause engaged"
          description: |
            The payout processor pause toggle has been active within the last five minutes.
            Confirm the pause is intentional and execute the payout incident runbook if required.

      - alert: PaymasterAutoTopUpSpikeWarning
        expr: sum(increase(nhb_paymaster_autotopups_total{outcome="success"}[5m])) > 3
        for: 10m
        labels:
          severity: warning
          team: treasury
        annotations:
          summary: "Automatic paymaster top-up spike (warning)"
          description: |
            More than three successful automatic paymaster top-ups executed within five minutes.
            Review recent sponsored activity and confirm the surge aligns with expected merchant load.

      - alert: PaymasterAutoTopUpSpikeCritical
        expr: sum(increase(nhb_paymaster_autotopups_total{outcome="success"}[5m])) > 10
        for: 10m
        labels:
          severity: critical
          team: treasury
        annotations:
          summary: "Automatic paymaster top-up spike (critical)"
          description: |
            More than ten successful automatic paymaster top-ups executed within five minutes.
            Treat the surge as a potential abuse event or runaway sponsorship configuration and
            coordinate with security for immediate review.

      - alert: PaymasterAutoTopUpCapSaturationWarning
        expr: sum(increase(nhb_paymaster_autotopups_total{outcome="failure"}[15m])) > 0
        for: 15m
        labels:
          severity: warning
          team: treasury
        annotations:
          summary: "Automatic paymaster top-ups nearing cap"
          description: |
            Automatic paymaster top-up failures were observed during the last 15 minutes. Inspect the
            `paymaster.autotopup` events for a `daily_cap_exceeded` reason and confirm the configured
            cap still matches the active budget.

      - alert: PaymasterAutoTopUpCapSaturationCritical
        expr: sum(increase(nhb_paymaster_autotopups_total{outcome="failure"}[15m])) > 3
        for: 15m
        labels:
          severity: critical
          team: treasury
        annotations:
          summary: "Automatic paymaster top-ups capped"
          description: |
            More than three automatic paymaster top-up failures occurred within 15 minutes. The
            paymaster is likely saturating its mint capâ€”raise limits or replenish balances before
            sponsored transactions are throttled.
